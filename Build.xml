<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="3.5" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Import Project="$(MSBuildExtensionsPath)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets"/>

  <UsingTask TaskName="NCoverExplorer.MSBuildTasks.NCover" AssemblyFile="C:\Program Files\NCover\NCoverExplorer\NCoverExplorer.MSBuildTasks.dll" />
  <UsingTask TaskName="NCoverExplorer.MSBuildTasks.NCoverExplorer" AssemblyFile="C:\Program Files\NCover\NCoverExplorer\NCoverExplorer.MSBuildTasks.dll" />
  
  <PropertyGroup>
    <!-- Build -->
    <Configuration Condition=" '$(Configuration)' == '' ">Release</Configuration>
    
    <!-- Assembly Version -->
    <AssemblyVersion>$(BUILD_NUMBER)</AssemblyVersion>
    <ScrewTurnVersion>$(SCREWTURNVERSION)</ScrewTurnVersion>
    <AgentTempDir>$(TEAMCITY_BUILD_TEMPDIR)</AgentTempDir>
    <AgentCheckoutDir>$(TEAMCITY_BUILD_CHECKOUTDIR)</AgentCheckoutDir>
    
    <!-- NCover -->
    <NCoverProjectName>$(TEAMCITY_PROJECTNAME) :: $(TEAMCITY_BUILDCONFNAME)</NCoverProjectName>
    <NCoverPath>C:\Program Files\NCover</NCoverPath>
    <NCoverExplorerPath>C:\Program Files\NCover</NCoverExplorerPath>
    <NUnitPath>C:\Program Files\NUnit 2.5.3\bin\net-2.0</NUnitPath>
    <NCoverWorkingDir>"$(TEAMCITY_BUILD_WORKINGDIR)"</NCoverWorkingDir>

    <NoCoverage>Namespace=$(NOCOVERAGENAMESPACES)</NoCoverage>
    <TestAssemblies>"$(TEAMCITY_BUILD_WORKINGDIR)$(NUNITTESTASSEMBLIES)"</TestAssemblies>
    <!--Which dll's contains the tests-->
    <CoverageAssemblies>$(COVERAGEASSEMBLIES)</CoverageAssemblies>
    <!--Which dll's should be covered-->

    <CoverageXmlReport>$(TEAMCITY_BUILD_WORKINGDIR)\Coverage.xml</CoverageXmlReport>
    <CoverageFullHtmlReport>$(TEAMCITY_BUILD_WORKINGDIR)\Coverage.html</CoverageFullHtmlReport>
    <CoverageSummaryHtmlReport>$(TEAMCITY_BUILD_WORKINGDIR)\CoverageSummary.html</CoverageSummaryHtmlReport>
    
  </PropertyGroup>

  <!-- Assign Assembly version numbers -->
  <Target Name="Version" BeforeTargets="Build">
    <Message Text="#--------- Updating Versions ---------#" />
    <ItemGroup>
      <AssemblyInfoFiles Include="**/Properties/**/AssemblyInfo.cs;" />
    </ItemGroup>

    <FileUpdate Files="@(AssemblyInfoFiles)" Regex='AssemblyVersion\(".*"\)\]' ReplacementText='AssemblyVersion("$(AssemblyVersion)")]'></FileUpdate>
    <FileUpdate Files="@(AssemblyInfoFiles)" Regex='AssemblyFileVersion\(".*"\)\]' ReplacementText='AssemblyFileVersion("$(AssemblyVersion)")]'></FileUpdate>
  </Target>
  
  <!-- The actual build -->
  <Target Name="Build" AfterTargets="Version">
    <Message Text="#--------- Building ---------#" />
    <MSBuild Projects="ScrewTurn.sln" Targets="Rebuild" Properties="Configuration=$(Configuration)" />
  </Target>

  <!-- What to do after bulid -->
  <Target Name="AfterBuild" AfterTargets="Build">
    <!-- Call NCover -->
    <CallTarget Condition=" '$(Configuration)' == 'Release' " Targets="Coverage" ContinueOnError="true" />
  </Target>


  <!-- NCover Generation -->
  <Target Name="Coverage">
    <Message Text="#--------- NCover Setup ---------#" />

    <Message Text="#--------- NCoverProjectName: $(NCoverProjectName) ---------#" />
    <Message Text="#--------- NCoverPath: $(NCoverPath) ---------#" />
    <Message Text="#--------- NCoverExplorerPath: $(NCoverExplorerPath) ---------#" />
    <Message Text="#--------- NUnitPath: $(NUnitPath) ---------#" />
    <Message Text="#--------- NCoverWorkingDir: $(NCoverWorkingDir) ---------#" />

    <Message Text="#--------- NoCoverage: $(NoCoverage) ---------#" />
    <Message Text="#--------- TestAssemblies: $(TestAssemblies) ---------#" />
    <Message Text="#--------- CoverageAssemblies: $(CoverageAssemblies) ---------#" />

    <Message Text="#--------- CoverageXmlReport: $(CoverageXmlReport) ---------#" />
    <Message Text="#--------- CoverageFullHtmlReport: $(CoverageFullHtmlReport) ---------#" />
    <Message Text="#--------- CoverageSummaryHtmlReport: $(CoverageSummaryHtmlReport) ---------#" />

    <Message Text="#--------- Executing NCover ---------#" />
    <NCover ToolPath="$(NCoverPath)"
            CommandLineExe="$(NUnitPath)\nunit-console.exe"
            CommandLineArgs="$(TestAssemblies)"
            CoverageFile="$(CoverageXmlReport)"
            LogFile="Coverage.log"
            AssemblyList="$(CoverageAssemblies)" />
      
    <!-- Generate HTML Reports -->
    <!-- Summary Page -->
    <Message Text="#--------- Summary Report ---------#" />
    <NCoverExplorer ToolPath="$(NCoverExplorerPath)"
                      ProjectName="$(NCoverProjectName)"
                      OutputDir="$(NCoverWorkingDir)"
                      CoverageFiles="$(CoverageXmlReport)"
                      SatisfactoryCoverage="80"
                      Exclusions="$(NoCoverage)"
                      ReportType="ModuleClassSummary"
                      HtmlReportName="CoverageSummary.html" />
    <!-- Full HTML Report -->
    <Message Text="#--------- Full Report ---------#" />
    <NCoverExplorer ToolPath="$(NCoverExplorerPath)"
                      ProjectName="$(NCoverProjectName)"
                      OutputDir="$(NCoverWorkingDir)"
                      CoverageFiles="$(CoverageXmlReport)"
                      SatisfactoryCoverage="80"
                      Exclusions="$(NoCoverage)"
                      ReportType="FullCoverageReport"
                      HtmlReportName="Coverage.html" />
  </Target>
</Project>