<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="3.5" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <Import Project="$(MSBuildExtensionsPath)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets"/>

  <UsingTask TaskName="NCoverExplorer.MSBuildTasks.NCover" AssemblyFile="C:\Program Files\NCover\NCoverExplorer\NCoverExplorer.MSBuildTasks.dll" />
  <UsingTask TaskName="NCoverExplorer.MSBuildTasks.NCoverExplorer" AssemblyFile="C:\Program Files\NCover\NCoverExplorer\NCoverExplorer.MSBuildTasks.dll" />
  
  <PropertyGroup>
    <!-- Build -->
    <Configuration Condition=" '$(Configuration)' == '' ">Release</Configuration>
  </PropertyGroup>

  <!-- Assign Assembly version numbers -->
  <!--###########################################################################################################################################################-->
  <Target Name="Version" BeforeTargets="Build">

    <PropertyGroup>
      <!-- Assembly Version -->
      <AssemblyVersion>$(BUILD_NUMBER)</AssemblyVersion>
    </PropertyGroup>
    
    <Message Text="#--------- Updating Versions to $(AssemblyVersion) ---------#" />
    <ItemGroup>
      <AssemblyInfoFiles Include="**/Properties/**/AssemblyInfo.cs;" />
    </ItemGroup>

    <FileUpdate Files="@(AssemblyInfoFiles)" Regex='AssemblyVersion\(".*"\)\]' ReplacementText='AssemblyVersion("$(AssemblyVersion)")]'></FileUpdate>
    <FileUpdate Files="@(AssemblyInfoFiles)" Regex='AssemblyFileVersion\(".*"\)\]' ReplacementText='AssemblyFileVersion("$(AssemblyVersion)")]'></FileUpdate>
  </Target>
  
  <!-- The actual build -->
  <!--###########################################################################################################################################################-->
  <Target Name="Build" AfterTargets="Version">
    <Message Text="#--------- Building ---------#" />
    <MSBuild Projects="ScrewTurn.sln" Targets="Rebuild" Properties="Configuration=$(Configuration)" />
  </Target>

  <!-- What to do after bulid -->
  <!--###########################################################################################################################################################-->
  <Target Name="AfterBuild" AfterTargets="Build">
    <!-- Call NCover -->
    <CallTarget Condition=" '$(Configuration)' == 'Release' " Targets="Coverage" ContinueOnError="true" />
  </Target>


  <!-- NCover Generation -->
  <!--###########################################################################################################################################################-->
  <Target Name="Coverage">

    <!-- NCover -->
    <PropertyGroup>
      <NCoverProjectName>$(TEAMCITY_PROJECTNAME) :: $(TEAMCITY_BUILDCONFNAME)</NCoverProjectName>
      <NCoverPath>C:\Program Files\NCover</NCoverPath>
      <NCoverExplorerPath>C:\Program Files\NCover</NCoverExplorerPath>
      <NUnitPath>C:\Program Files\NUnit 2.5.3\bin\net-2.0</NUnitPath>
      <NCoverWorkingDir>$(TEAMCITY_BUILD_WORKINGDIR)</NCoverWorkingDir>

      <NoCoverage>Assembly=$(NOCOVERAGENAMESPACES);Namespace=$(NOCOVERAGENAMESPACES)</NoCoverage>
      <TestAssemblies>"$(TEAMCITY_BUILD_WORKINGDIR)$(NUNITTESTASSEMBLIES)"</TestAssemblies>
      <CoverageAssemblies>$(COVERAGEASSEMBLIES)</CoverageAssemblies>

      <ReportDir>$(TEAMCITY_BUILD_WORKINGDIR)\Reports</ReportDir>

      <NUnitReport>"$(TEAMCITY_BUILD_WORKINGDIR)\Reports\NUnitReport.xml"</NUnitReport>
      <CoverageLog>$(TEAMCITY_BUILD_WORKINGDIR)\Reports\NCoverLog.log</CoverageLog>
      <CoverageXmlReport>$(TEAMCITY_BUILD_WORKINGDIR)\Reports\NCoverReport.xml</CoverageXmlReport>
    </PropertyGroup>
    
    
    <Message Text="#--------- NCover Setup ---------#" />
    <Message Text="###########################################################################" />

    <Message Text="# NCoverProjectName: $(NCoverProjectName) " />
    <Message Text="# NCoverPath: $(NCoverPath) " />
    <Message Text="# NCoverExplorerPath: $(NCoverExplorerPath) " />
    <Message Text="# NUnitPath: $(NUnitPath) " />
    <Message Text="# NCoverWorkingDir: $(NCoverWorkingDir) " />

    <Message Text="# NoCoverage: $(NoCoverage) " />
    <Message Text="# TestAssemblies: $(TestAssemblies) " />
    <Message Text="# CoverageAssemblies: $(CoverageAssemblies) " />

    <Message Text="# ReportDir: $(ReportDir) " />
    <Message Text="# CoverageLog: $(CoverageLog) " />
    <Message Text="# CoverageXmlReport: $(CoverageXmlReport) " />
    <Message Text="###########################################################################" />

    <Message Text="#--------- Executing NCover ---------#" />

    <Message Text="##teamcity[progressStart 'Cleaning reports']"/>
    
    <RemoveDir Directories="$(ReportDir)" Condition="Exists('$(ReportDir)')" />
    <MakeDir Directories="$(ReportDir)" Condition="!Exists('$(ReportDir)')" />

    <Message Text="##teamcity[progressFinish 'Cleaning reports']"/>

    <Message Text="##teamcity[progressStart 'Running NCover 1.5.8.']"/>
    <Message Text="##teamcity[progressFinish 'Running NCover 1.5.8.']"/>
    <NCover ToolPath="$(NCoverPath)"
            CommandLineExe="$(NUnitPath)\nunit-console.exe"
            CommandLineArgs=" /xml:$(NUnitReport) $(TestAssemblies)"
            CoverageFile="$(CoverageXmlReport)"
            LogFile="$(CoverageLog)"
            AssemblyList="$(CoverageAssemblies)" />

    <!-- Theese are for visual inspection in TC and Release package only -->
    <Message Text="##teamcity[progressStart 'Generating NCover Reports']"/>
    
    <Message Text="#--------- Generating Reports ---------#" />
    <Message Text="#--------- ModuleSummary Report ---------#" />
    <NCoverExplorer ToolPath="$(NCoverExplorerPath)"
                      ProjectName="$(NCoverProjectName)"
                      OutputDir="$(NCoverWorkingDir)"
                      CoverageFiles="$(CoverageXmlReport)"
                      SatisfactoryCoverage="95"
                      Exclusions="$(NoCoverage)"
                      ReportType="ModuleSummary"
                      HtmlReportName="$(ReportDir)\NCoverModuleSummary.html" />

    <Message Text="#--------- ModuleClassSummary Report ---------#" />
    <NCoverExplorer ToolPath="$(NCoverExplorerPath)"
                      ProjectName="$(NCoverProjectName)"
                      OutputDir="$(NCoverWorkingDir)"
                      CoverageFiles="$(CoverageXmlReport)"
                      SatisfactoryCoverage="95"
                      Exclusions="$(NoCoverage)"
                      ReportType="ModuleClassSummary"
                      HtmlReportName="$(ReportDir)\NCoverModuleClassSummary.html" />

    <Message Text="#--------- ModuleNamespaceSummary Report ---------#" />
    <NCoverExplorer ToolPath="$(NCoverExplorerPath)"
                      ProjectName="$(NCoverProjectName)"
                      OutputDir="$(NCoverWorkingDir)"
                      CoverageFiles="$(CoverageXmlReport)"
                      SatisfactoryCoverage="95"
                      Exclusions="$(NoCoverage)"
                      ReportType="ModuleNamespaceSummary"
                      HtmlReportName="$(ReportDir)\NCoverModuleNamespaceSummary.html" />

    <Message Text="#--------- ModuleClassFunctionSummary Report ---------#" />
    <NCoverExplorer ToolPath="$(NCoverExplorerPath)"
                      ProjectName="$(NCoverProjectName)"
                      OutputDir="$(NCoverWorkingDir)"
                      CoverageFiles="$(CoverageXmlReport)"
                      SatisfactoryCoverage="95"
                      Exclusions="$(NoCoverage)"
                      ReportType="ModuleClassFunctionSummary"
                      HtmlReportName="$(ReportDir)\NCoverModuleClassFunctionSummary.html" />
    
    <Message Text="##teamcity[progressFinish 'Generating NCover Reports']"/>


    <!-- Report to TC, to add to statistics -->
    <!--<Message Text="##teamcity[dotNetCoverage ncover_explorer_tool='$(CoverageXmlReport)']"/>
    <Message Text="##teamcity[dotNetCoverage ncover_explorer_tool_args='$(CoverageXmlReport)']"/>-->
    <Message Text="##teamcity[dotNetCoverage ncover_explorer_report_type='0']"/>
    <Message Text="##teamcity[dotNetCoverage ncover_explorer_report_order='0']"/>
    <!-- This will generate the standard summary if not remove from config -->
    <Message Text="##teamcity[importData type='dotNetCoverage' tool='ncover' path='$(CoverageXmlReport)']"/>
    
  </Target>

</Project>